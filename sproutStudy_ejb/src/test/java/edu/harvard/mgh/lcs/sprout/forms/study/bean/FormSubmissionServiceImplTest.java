package edu.harvard.mgh.lcs.sprout.forms.study.bean;

import edu.harvard.mgh.lcs.sprout.forms.study.util.StringUtils;
import junit.framework.TestCase;
import org.junit.Test;

import javax.xml.transform.*;
import javax.xml.transform.stream.StreamSource;
import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.StringReader;
import java.io.StringWriter;

/**
 * Created by slorenz on 1/31/2014.
 */
public class FormSubmissionServiceImplTest extends TestCase {

    @Test
    public void testTransform() throws Exception {

        String[] matchedAssertions = {"jones@last_name", "bill@first_name"};
        String submissionModel = "<?xml version=\"1.0\" encoding=\"UTF-8\"?><submission><meta><timestamp>2014-05-20T17:00:43.970-04:00</timestamp><datestamp>05/20/2014</datestamp><dictionary>SPROUT_INTERNAL</dictionary><user><identities><identity schema=\"empi\" scope=\"domain\">100790917</identity><identity schema=\"mgh\" scope=\"domain\">3861810</identity><identity schema=\"temp_id\" scope=\"domain\">24cfc8e1-56f9-4ae0-ac43-2a8c665850b3</identity><identity schema=\"ihsid\" scope=\"domain\">2087</identity><assertions><assertion><name>first_name</name><value>PERCIVAL</value><identityInd>false</identityInd><label>First name</label><variableName>FLD221_first_name_332880</variableName><searchField>firstName</searchField></assertion><assertion><name>middle_name</name><value/><identityInd>false</identityInd><label>Middle name</label><variableName>FLD221_middle_name_332881</variableName></assertion><assertion><name>last_name</name><value>OE-TEST</value><identityInd>false</identityInd><label>Last name</label><variableName>FLD221_last_name_332882</variableName><searchField>lastName</searchField></assertion><assertion><name>pt_dob</name><value>01/01/1940</value><identityInd>false</identityInd><label>Date of Birth</label><variableName>FLD221_pt_dob_332883</variableName></assertion><assertion><name>pt_gender</name><value>M</value><identityInd>false</identityInd><label>Gender</label><variableName>FLD221_pt_gender_332886</variableName><searchField>gender</searchField></assertion><assertion><name>record_number</name><value>3861810</value><identityInd>true</identityInd><label>Hospital Medical Record Number</label><variableName>FLD221_record_number_332887</variableName></assertion></assertions></identities></user><form id=\"344\"><template_id>4216</template_id><template_version>61</template_version><title>NewAdults Form</title></form><instance><parameter name=\"pun\">as431</parameter><parameter name=\"tempId\">24cfc8e1-56f9-4ae0-ac43-2a8c665850b3</parameter><parameter name=\"ihsid\">2087</parameter><parameter name=\"scheme\">TEMP_ID</parameter></instance><publication id=\"05B6ACC1-94E1-4CDA-BD3C-CD99540D2FF2\"><title>MGH Down Syndrome Program New Visit Intake Form (Adults)</title><description>NewAdults Form</description><publisher_dn>uid=jc713,ou=Users,o=Partners Healthcare,dc=sproutforms,dc=org</publisher_dn><contact_name/><contact_email/><validity_interval>0</validity_interval></publication></meta><model xmlns:frm_mgh_down_syndrom=\"http://www.sproutforms.org/forms/frm_mgh_down_syndrom\" xmlns:lib_demographics=\"http://www.sproutforms.org/forms/lib_demographics\" xmlns:lib_dsp_prefcon=\"http://www.sproutforms.org/forms/lib_dsp_prefcon\" xmlns:lib_medical_records=\"http://www.sproutforms.org/forms/lib_medical_records\" xmlns:lib_insurance=\"http://www.sproutforms.org/forms/lib_insurance\" xmlns:lib_dsp_concerns=\"http://www.sproutforms.org/forms/lib_dsp_concerns\" xmlns:lib_dsp_strengths=\"http://www.sproutforms.org/forms/lib_dsp_strengths\" xmlns:lib_past_medical_his=\"http://www.sproutforms.org/forms/lib_past_medical_his\" xmlns:lib_hosps_and_procs=\"http://www.sproutforms.org/forms/lib_hosps_and_procs\" xmlns:lib_medications=\"http://www.sproutforms.org/forms/lib_medications\" xmlns:lib_supplements=\"http://www.sproutforms.org/forms/lib_supplements\" xmlns:lib_allergies=\"http://www.sproutforms.org/forms/lib_allergies\" xmlns:lib_ros_pediatrics=\"http://www.sproutforms.org/forms/lib_ros_pediatrics\" xmlns:lib_immunizations=\"http://www.sproutforms.org/forms/lib_immunizations\" xmlns:lib_family_hx=\"http://www.sproutforms.org/forms/lib_family_hx\" xmlns:lib_dsp_living=\"http://www.sproutforms.org/forms/lib_dsp_living\" xmlns:lib_dsp_devices=\"http://www.sproutforms.org/forms/lib_dsp_devices\" xmlns:lib_dsp_vocexp=\"http://www.sproutforms.org/forms/lib_dsp_vocexp\" xmlns:lib_dsp_fxnal=\"http://www.sproutforms.org/forms/lib_dsp_fxnal\" xmlns:lib_dsp_recreation=\"http://www.sproutforms.org/forms/lib_dsp_recreation\" xmlns:lib_dsp_diet=\"http://www.sproutforms.org/forms/lib_dsp_diet\" xmlns:lib_dsp_transitions=\"http://www.sproutforms.org/forms/lib_dsp_transitions\" xmlns:lib_dsp_labsdx=\"http://www.sproutforms.org/forms/lib_dsp_labsdx\" xmlns:lib_dsp_community=\"http://www.sproutforms.org/forms/lib_dsp_community\" xmlns:lib_dsp_plans=\"http://www.sproutforms.org/forms/lib_dsp_plans\"><frm_mgh_down_syndrom:introduction/><frm_mgh_down_syndrom:dsp_share/><frm_mgh_down_syndrom:dsp_share_signature>1</frm_mgh_down_syndrom:dsp_share_signature><frm_mgh_down_syndrom:dsp_registration/><frm_mgh_down_syndrom:dsp_registration_signature>1</frm_mgh_down_syndrom:dsp_registration_signature><lib_demographics:form_self_complete>0</lib_demographics:form_self_complete><lib_demographics:first_name>Joseph</lib_demographics:first_name><lib_demographics:middle_name/><lib_demographics:last_name>Millerton</lib_demographics:last_name><lib_demographics:pt_dob>01/01/1940</lib_demographics:pt_dob><lib_demographics:pt_age>74</lib_demographics:pt_age><lib_demographics:pt_age_months>892</lib_demographics:pt_age_months><lib_demographics:pt_gender>M</lib_demographics:pt_gender><lib_demographics:record_number>3861810</lib_demographics:record_number><lib_demographics:black/><lib_demographics:white/><lib_demographics:american_indian/><lib_demographics:alaska_native/><lib_demographics:asian>1</lib_demographics:asian><lib_demographics:asian_indian/><lib_demographics:chinese>1</lib_demographics:chinese><lib_demographics:filipino/><lib_demographics:korean/><lib_demographics:japanese/><lib_demographics:vietnamese/><lib_demographics:other_asian/><lib_demographics:asian_composite/><lib_demographics:hawaiian/><lib_demographics:race_other/><lib_demographics:race_other_detail/><lib_demographics:race_composite/><lib_demographics:hispanic_or_latino>0</lib_demographics:hispanic_or_latino><lib_demographics:mexican/><lib_demographics:mexican_american/><lib_demographics:chicano/><lib_demographics:puerto_rican/><lib_demographics:cuban/><lib_demographics:cuban_american/><lib_demographics:other_hispanic/><lib_demographics:ethnicity_composite/><lib_demographics:religion>9</lib_demographics:religion><lib_demographics:religion_other/><lib_demographics:patient_information_composite/><lib_demographics:interpreter>1</lib_demographics:interpreter><lib_demographics:spoken_language>Mandarin</lib_demographics:spoken_language><lib_demographics:interpreter_composite/><lib_demographics:caregiver_salutation/><lib_demographics:caregiver_first_name>Josephmom</lib_demographics:caregiver_first_name><lib_demographics:caregiver_last_name>Millerton</lib_demographics:caregiver_last_name><lib_demographics:caregiver_guardian>1</lib_demographics:caregiver_guardian><lib_demographics:own_guardian/><lib_demographics:guardian_name/><lib_demographics:guardian_instruction/><lib_demographics:caregiver_relationship>1</lib_demographics:caregiver_relationship><lib_demographics:caregiver_relationship_detail/><lib_demographics:caregiver_composite/><lib_dsp_prefcon:contact_label/><lib_dsp_prefcon:contact_name>Josephmom Millerton</lib_dsp_prefcon:contact_name><lib_dsp_prefcon:contact_mailing_address>3453 North Cambridge Avenue</lib_dsp_prefcon:contact_mailing_address><lib_dsp_prefcon:contact_city>Boston</lib_dsp_prefcon:contact_city><lib_dsp_prefcon:contact_state>MA</lib_dsp_prefcon:contact_state><lib_dsp_prefcon:contact_zip>34234</lib_dsp_prefcon:contact_zip><lib_dsp_prefcon:contact_phone>(234) 223-4233</lib_dsp_prefcon:contact_phone><lib_dsp_prefcon:contact_email/><lib_dsp_prefcon:contact_relationship>Mother</lib_dsp_prefcon:contact_relationship><lib_dsp_prefcon:hcp/><lib_dsp_prefcon:employer_table><row><employer_guardian/><employer_name/></row></lib_dsp_prefcon:employer_table><lib_medical_records:pcp_first_name>David</lib_medical_records:pcp_first_name><lib_medical_records:pcp_last_name>Campbell</lib_medical_records:pcp_last_name><lib_medical_records:pcp_address_1>992 South Apple Drive</lib_medical_records:pcp_address_1><lib_medical_records:pcp_address_2>Suite 700</lib_medical_records:pcp_address_2><lib_medical_records:pcp_city>Bensonhurst</lib_medical_records:pcp_city><lib_medical_records:pcp_state>NY</lib_medical_records:pcp_state><lib_medical_records:pcp_zip>32432</lib_medical_records:pcp_zip><lib_medical_records:pcp_phone>(798) 968-6868</lib_medical_records:pcp_phone><lib_medical_records:pcp_fax/><lib_medical_records:pcp_info/><lib_medical_records:medical_records><row><mr_location/><mr_address/><mr_phone/><mr_specialty/><mr_share>1</mr_share></row></lib_medical_records:medical_records><lib_insurance:insurance_primary>Kaiser</lib_insurance:insurance_primary><lib_insurance:insurance_primary_name>Josephdad</lib_insurance:insurance_primary_name><lib_insurance:insurance_primary_dob>01/01/1932</lib_insurance:insurance_primary_dob><lib_insurance:insurance_secondary_boo>0</lib_insurance:insurance_secondary_boo><lib_insurance:insurance_secondary/><lib_insurance:insurance_secondary_name/><lib_insurance:insurance_secondary_dob/><lib_dsp_concerns:concern_table><row><concern_table_description>Wetting bed</concern_table_description><concern_table_severity>5</concern_table_severity><concern_table_talk>1</concern_table_talk></row></lib_dsp_concerns:concern_table><lib_dsp_concerns:emotional_concerns/><lib_dsp_strengths:strengths_label/><lib_dsp_strengths:strengths>Learning to play chess</lib_dsp_strengths:strengths><lib_past_medical_his:pmh_label/><lib_past_medical_his:pmh_strabismus/><lib_past_medical_his:pmh_strabismus_status/><lib_past_medical_his:pmh_strabismus_clinician/><lib_past_medical_his:pmh_strabismus_last_visit/><lib_past_medical_his:pmh_hyperopia>1</lib_past_medical_his:pmh_hyperopia><lib_past_medical_his:pmh_hyperopia_status>1</lib_past_medical_his:pmh_hyperopia_status><lib_past_medical_his:pmh_hyperopia_clinician/><lib_past_medical_his:pmh_hyperopia_last_visit/><lib_past_medical_his:pmh_astigmatism>1</lib_past_medical_his:pmh_astigmatism><lib_past_medical_his:pmh_astigmatism_status>0</lib_past_medical_his:pmh_astigmatism_status><lib_past_medical_his:pmh_astigmatism_clinician/><lib_past_medical_his:pmh_astigmatism_last_visit/><lib_past_medical_his:pmh_nystagmus/><lib_past_medical_his:pmh_nystagmus_status/><lib_past_medical_his:pmh_nystagmus_clinician/><lib_past_medical_his:pmh_nystagmus_last_visit/><lib_past_medical_his:pmh_myopia/><lib_past_medical_his:pmh_myopia_status/><lib_past_medical_his:pmh_myopia_clinician/><lib_past_medical_his:pmh_myopia_last_visit/><lib_past_medical_his:pmh_cataracts/><lib_past_medical_his:pmh_cataracts_status/><lib_past_medical_his:pmh_cataracts_clinician/><lib_past_medical_his:pmh_cataracts_last_visit/><lib_past_medical_his:pmh_keratoconus/><lib_past_medical_his:pmh_keratoconus_status/><lib_past_medical_his:pmh_keratoconus_clinician/><lib_past_medical_his:pmh_keratoconus_last_visit/><lib_past_medical_his:pmh_eyes_grid/><lib_past_medical_his:pmh_ear_infections/><lib_past_medical_his:pmh_ear_infections_status/><lib_past_medical_his:pmh_ear_infections_clinician/><lib_past_medical_his:pmh_ear_infections_last_visit/><lib_past_medical_his:pmh_ear_tubes/><lib_past_medical_his:pmh_ear_tubes_status/><lib_past_medical_his:pmh_ear_tubes_clinician/><lib_past_medical_his:pmh_ear_tubes_last_visit/><lib_past_medical_his:pmh_hearing_loss/><lib_past_medical_his:pmh_hearing_loss_status/><lib_past_medical_his:pmh_hearing_loss_clinician/><lib_past_medical_his:pmh_hearing_loss_last_visit/><lib_past_medical_his:pmh_ent_grid/><lib_past_medical_his:pmh_chd/><lib_past_medical_his:pmh_chd_status/><lib_past_medical_his:pmh_chd_clinician/><lib_past_medical_his:pmh_chd_last_visit/><lib_past_medical_his:pmh_asd/><lib_past_medical_his:pmh_asd_status/><lib_past_medical_his:pmh_asd_clinician/><lib_past_medical_his:pmh_asd_last_visit/><lib_past_medical_his:pmh_vsd/><lib_past_medical_his:pmh_vsd_status/><lib_past_medical_his:pmh_vsd_clinician/><lib_past_medical_his:pmh_vsd_last_visit/><lib_past_medical_his:pmh_avsd/><lib_past_medical_his:pmh_avsd_status/><lib_past_medical_his:pmh_avsd_clinician/><lib_past_medical_his:pmh_avsd_last_visit/><lib_past_medical_his:pmh_pda/><lib_past_medical_his:pmh_pda_status/><lib_past_medical_his:pmh_pda_clinician/><lib_past_medical_his:pmh_pda_last_visit/><lib_past_medical_his:pmh_tof/><lib_past_medical_his:pmh_tof_status/><lib_past_medical_his:pmh_tof_clinician/><lib_past_medical_his:pmh_tof_last_visit/><lib_past_medical_his:pmh_hyperlipidemia/><lib_past_medical_his:pmh_hyperlipidemia_status/><lib_past_medical_his:pmh_hyperlipidemia_clinician/><lib_past_medical_his:pmh_hyperlipidemia_last_visit/><lib_past_medical_his:pmh_cardiac_grid/><lib_past_medical_his:pmh_pna/><lib_past_medical_his:pmh_pna_status/><lib_past_medical_his:pmh_pna_clinician/><lib_past_medical_his:pmh_pna_last_visit/><lib_past_medical_his:pmh_asthma/><lib_past_medical_his:pmh_asthma_status/><lib_past_medical_his:pmh_asthma_clinician/><lib_past_medical_his:pmh_asthma_last_visit/><lib_past_medical_his:pmh_osa/><lib_past_medical_his:pmh_osa_status/><lib_past_medical_his:pmh_osa_clinician/><lib_past_medical_his:pmh_osa_last_visit/><lib_past_medical_his:pmh_lungs_grid/><lib_past_medical_his:pmh_constipation/><lib_past_medical_his:pmh_constipation_status/><lib_past_medical_his:pmh_constipation_clinician/><lib_past_medical_his:pmh_constipation_last_visit/><lib_past_medical_his:pmh_gerd/><lib_past_medical_his:pmh_gerd_status/><lib_past_medical_his:pmh_gerd_clinician/><lib_past_medical_his:pmh_gerd_last_visit/><lib_past_medical_his:pmh_duo_atresia/><lib_past_medical_his:pmh_duo_atresia_status/><lib_past_medical_his:pmh_duo_atresia_clinician/><lib_past_medical_his:pmh_duo_atresia_last_visit/><lib_past_medical_his:pmh_hirschsprungs/><lib_past_medical_his:pmh_hirschsprungs_status/><lib_past_medical_his:pmh_hirschsprungs_clinician/><lib_past_medical_his:pmh_hirschsprungs_last_visit/><lib_past_medical_his:pmh_celiac/><lib_past_medical_his:pmh_celiac_status/><lib_past_medical_his:pmh_celiac_clinician/><lib_past_medical_his:pmh_celiac_last_visit/><lib_past_medical_his:pmh_lactose/><lib_past_medical_his:pmh_lactose_status/><lib_past_medical_his:pmh_lactose_clinician/><lib_past_medical_his:pmh_lactose_last_visit/><lib_past_medical_his:pmh_anus/><lib_past_medical_his:pmh_anus_status/><lib_past_medical_his:pmh_anus_clinician/><lib_past_medical_his:pmh_anus_last_visit/><lib_past_medical_his:pmh_tefistula/><lib_past_medical_his:pmh_tefistula_status/><lib_past_medical_his:pmh_tefistula_clinician/><lib_past_medical_his:pmh_tefistula_last_visit/><lib_past_medical_his:pmh_gi_grid/><lib_past_medical_his:pmh_seizures/><lib_past_medical_his:pmh_seizures_status/><lib_past_medical_his:pmh_seizures_clinician/><lib_past_medical_his:pmh_seizures_last_visit/><lib_past_medical_his:pmh_autism/><lib_past_medical_his:pmh_autism_status/><lib_past_medical_his:pmh_autism_clinician/><lib_past_medical_his:pmh_autism_last_visit/><lib_past_medical_his:pmh_dementia/><lib_past_medical_his:pmh_dementia_status/><lib_past_medical_his:pmh_dementia_clinician/><lib_past_medical_his:pmh_dementia_last_visit/><lib_past_medical_his:pmh_cognitive_decline/><lib_past_medical_his:pmh_cognitive_decline_status/><lib_past_medical_his:pmh_cognitive_decline_clinician/><lib_past_medical_his:pmh_cognitive_decline_last_visit/><lib_past_medical_his:pmh_expressive_language/><lib_past_medical_his:pmh_expressive_language_status/><lib_past_medical_his:pmh_expressive_language_clinician/><lib_past_medical_his:pmh_expressive_language_last_visit/><lib_past_medical_his:pmh_hypotonia/><lib_past_medical_his:pmh_hypotonia_status/><lib_past_medical_his:pmh_hypotonia_clinician/><lib_past_medical_his:pmh_hypotonia_last_visit/><lib_past_medical_his:pmh_cns_grid/><lib_past_medical_his:pmh_eczema/><lib_past_medical_his:pmh_eczema_status/><lib_past_medical_his:pmh_eczema_clinician/><lib_past_medical_his:pmh_eczema_last_visit/><lib_past_medical_his:pmh_dry_skin/><lib_past_medical_his:pmh_dry_skin_status/><lib_past_medical_his:pmh_dry_skin_clinician/><lib_past_medical_his:pmh_dry_skin_last_visit/><lib_past_medical_his:pmh_onycholysis/><lib_past_medical_his:pmh_onycholysis_status/><lib_past_medical_his:pmh_onycholysis_clinician/><lib_past_medical_his:pmh_onycholysis_last_visit/><lib_past_medical_his:pmh_hair_loss/><lib_past_medical_his:pmh_hair_loss_status/><lib_past_medical_his:pmh_hair_loss_clinician/><lib_past_medical_his:pmh_hair_loss_last_visit/><lib_past_medical_his:pmh_skin_grid/><lib_past_medical_his:pmh_scoliosis/><lib_past_medical_his:pmh_scoliosis_status/><lib_past_medical_his:pmh_scoliosis_clinician/><lib_past_medical_his:pmh_scoliosis_last_visit/><lib_past_medical_his:pmh_aa_instability/><lib_past_medical_his:pmh_aa_instability_status/><lib_past_medical_his:pmh_aa_instability_clinician/><lib_past_medical_his:pmh_aa_instability_last_visit/><lib_past_medical_his:pmh_hip_problems/><lib_past_medical_his:pmh_hip_problems_status/><lib_past_medical_his:pmh_hip_problems_clinician/><lib_past_medical_his:pmh_hip_problems_last_visit/><lib_past_medical_his:pmh_oa/><lib_past_medical_his:pmh_oa_status/><lib_past_medical_his:pmh_oa_clinician/><lib_past_medical_his:pmh_oa_last_visit/><lib_past_medical_his:pmh_msk_grid/><lib_past_medical_his:pmh_hypothyroidism/><lib_past_medical_his:pmh_hypothyroidism_status/><lib_past_medical_his:pmh_hypothyroidism_clinician/><lib_past_medical_his:pmh_hypothyroidism_last_visit/><lib_past_medical_his:pmh_hyperthyroidism/><lib_past_medical_his:pmh_hyperthyroidism_status/><lib_past_medical_his:pmh_hyperthyroidism_clinician/><lib_past_medical_his:pmh_hyperthyroidism_last_visit/><lib_past_medical_his:pmh_dm/><lib_past_medical_his:pmh_dm_status/><lib_past_medical_his:pmh_dm_clinician/><lib_past_medical_his:pmh_dm_last_visit/><lib_past_medical_his:pmh_osteoporosis/><lib_past_medical_his:pmh_osteoporosis_status/><lib_past_medical_his:pmh_osteoporosis_clinician/><lib_past_medical_his:pmh_osteoporosis_last_visit/><lib_past_medical_his:pmh_endocrine_grid/><lib_past_medical_his:pmh_all/><lib_past_medical_his:pmh_all_status/><lib_past_medical_his:pmh_all_clinician/><lib_past_medical_his:pmh_all_last_visit/><lib_past_medical_his:pmh_aml/><lib_past_medical_his:pmh_aml_status/><lib_past_medical_his:pmh_aml_clinician/><lib_past_medical_his:pmh_aml_last_visit/><lib_past_medical_his:pmh_tmpo/><lib_past_medical_his:pmh_tmpo_status/><lib_past_medical_his:pmh_tmpo_clinician/><lib_past_medical_his:pmh_tmpo_last_visit/><lib_past_medical_his:pmh_anemia/><lib_past_medical_his:pmh_anemia_status/><lib_past_medical_his:pmh_anemia_clinician/><lib_past_medical_his:pmh_anemia_last_visit/><lib_past_medical_his:pmh_heme_grid/><lib_past_medical_his:pmh_depression/><lib_past_medical_his:pmh_depression_status/><lib_past_medical_his:pmh_depression_clinician/><lib_past_medical_his:pmh_depression_last_visit/><lib_past_medical_his:pmh_anxiety/><lib_past_medical_his:pmh_anxiety_status/><lib_past_medical_his:pmh_anxiety_clinician/><lib_past_medical_his:pmh_anxiety_last_visit/><lib_past_medical_his:pmh_ocd/><lib_past_medical_his:pmh_ocd_status/><lib_past_medical_his:pmh_ocd_clinician/><lib_past_medical_his:pmh_ocd_last_visit/><lib_past_medical_his:pmh_adhd/><lib_past_medical_his:pmh_adhd_status/><lib_past_medical_his:pmh_adhd_clinician/><lib_past_medical_his:pmh_adhd_last_visit/><lib_past_medical_his:pmh_ptsd/><lib_past_medical_his:pmh_ptsd_status/><lib_past_medical_his:pmh_ptsd_clinician/><lib_past_medical_his:pmh_ptsd_last_visit/><lib_past_medical_his:pmh_psych_grid/><lib_past_medical_his:pmh_sleep_disorder/><lib_past_medical_his:pmh_sleep_disorder_status/><lib_past_medical_his:pmh_sleep_disorder_clinician/><lib_past_medical_his:pmh_sleep_disorder_last_visit/><lib_past_medical_his:pmh_obesity/><lib_past_medical_his:pmh_obesity_status/><lib_past_medical_his:pmh_obesity_clinician/><lib_past_medical_his:pmh_obesity_last_visit/><lib_past_medical_his:pmh_cancer/><lib_past_medical_his:pmh_cancer_status/><lib_past_medical_his:pmh_cancer_clinician/><lib_past_medical_his:pmh_cancer_last_visit/><lib_past_medical_his:pmh_other_grid/><lib_past_medical_his:pmh_table><row><pmh_repeat_dx/><pmh_repeat_dx_resolved/><pmh_repeat_dx_clinician/></row></lib_past_medical_his:pmh_table><lib_hosps_and_procs:surgery_table><row><surgery_repeat_row_type>Appendectomy</surgery_repeat_row_type><surgery_repeat_row_hospital>mgh</surgery_repeat_row_hospital><surgery_repeat_row_date>fall 2009</surgery_repeat_row_date><surgery_repeat_row_comment>app comments</surgery_repeat_row_comment></row></lib_hosps_and_procs:surgery_table><lib_hosps_and_procs:hospitalization_table><row><hospitalization_repeat_row_reason/><hospitalization_repeat_row_hospital_name/><hospitalization_repeat_row_date/><hospitalization_repeat_row_comment/></row></lib_hosps_and_procs:hospitalization_table><lib_medications:take_rxs>0</lib_medications:take_rxs><lib_medications:rxs><row><rx_name/><rx_code_tmp/><rx_strength_form/><rx_code/><rx_frequency/><rx_directions/><rx_prescribed_by/><rx_began_taking/></row></lib_medications:rxs><lib_supplements:take_supplements>0</lib_supplements:take_supplements><lib_supplements:supplements_rx><row><supplement_name/><supplement_reason/></row></lib_supplements:supplements_rx><lib_allergies:have_rx_allergies>2</lib_allergies:have_rx_allergies><lib_allergies:allergies><row><allergy_name/><allergy_reaction/><allergy_reaction_date/></row></lib_allergies:allergies><lib_ros_pediatrics:instructions_label_last_12/><lib_ros_pediatrics:fever/><lib_ros_pediatrics:weight_gain/><lib_ros_pediatrics:weight_loss>1</lib_ros_pediatrics:weight_loss><lib_ros_pediatrics:increasing_fatigue/><lib_ros_pediatrics:new_behavioral_problems/><lib_ros_pediatrics:general_other/><lib_ros_pediatrics:general_other_detail/><lib_ros_pediatrics:general_composite/><lib_ros_pediatrics:concerns_about_vision/><lib_ros_pediatrics:cataracts/><lib_ros_pediatrics:lazy_eye>1</lib_ros_pediatrics:lazy_eye><lib_ros_pediatrics:eyes_other/><lib_ros_pediatrics:eyes_other_detail/><lib_ros_pediatrics:eyes_composite/><lib_ros_pediatrics:ear_infection/><lib_ros_pediatrics:ear_wax/><lib_ros_pediatrics:hearing_loss/><lib_ros_pediatrics:sinus_problems/><lib_ros_pediatrics:runny_nose/><lib_ros_pediatrics:frequent_sore_throat/><lib_ros_pediatrics:ent_other/><lib_ros_pediatrics:ent_other_detail/><lib_ros_pediatrics:ent_composite/><lib_ros_pediatrics:gum_disease/><lib_ros_pediatrics:gum_problems/><lib_ros_pediatrics:cavities/><lib_ros_pediatrics:brushing/><lib_ros_pediatrics:flossing/><lib_ros_pediatrics:dental_other/><lib_ros_pediatrics:dental_other_detail/><lib_ros_pediatrics:dental_composite/><lib_ros_pediatrics:murmur/><lib_ros_pediatrics:chest_pain/><lib_ros_pediatrics:poor_exercise_tolerance/><lib_ros_pediatrics:sweating_when_feeding/><lib_ros_pediatrics:cv_other/><lib_ros_pediatrics:cv_other_detail/><lib_ros_pediatrics:cv_composite/><lib_ros_pediatrics:wheezing/><lib_ros_pediatrics:difficulty_breathing/><lib_ros_pediatrics:lungs_other/><lib_ros_pediatrics:lungs_other_detail/><lib_ros_pediatrics:lungs_composite/><lib_ros_pediatrics:stomach_complaints/><lib_ros_pediatrics:vomiting/><lib_ros_pediatrics:nausea/><lib_ros_pediatrics:reflux/><lib_ros_pediatrics:constipation/><lib_ros_pediatrics:diarrhea/><lib_ros_pediatrics:underweight/><lib_ros_pediatrics:overweight/><lib_ros_pediatrics:stomach_other/><lib_ros_pediatrics:stomach_other_detail/><lib_ros_pediatrics:gi_composite/><lib_ros_pediatrics:trouble_eating/><lib_ros_pediatrics:trouble_drinking/><lib_ros_pediatrics:aspiration/><lib_ros_pediatrics:gagging_with_food/><lib_ros_pediatrics:dietary_needs/><lib_ros_pediatrics:feeding_other/><lib_ros_pediatrics:feeding_other_detail/><lib_ros_pediatrics:feeding_composite/><lib_ros_pediatrics:toilet_training/><lib_ros_pediatrics:accidents_urine/><lib_ros_pediatrics:accidents_stool/><lib_ros_pediatrics:toileting_other/><lib_ros_pediatrics:toileting_other_detail/><lib_ros_pediatrics:toileting_composite/><lib_ros_pediatrics:irregular_menstruation/><lib_ros_pediatrics:menstrual_cramps/><lib_ros_pediatrics:menstruation_onset/><lib_ros_pediatrics:menstruation_onset_age/><lib_ros_pediatrics:concerns_masturbation/><lib_ros_pediatrics:reproductive_other/><lib_ros_pediatrics:reproductive_other_detail/><lib_ros_pediatrics:reproductive_composite/><lib_ros_pediatrics:rash/><lib_ros_pediatrics:dry_skin/><lib_ros_pediatrics:eczema/><lib_ros_pediatrics:hair_loss/><lib_ros_pediatrics:skin_other/><lib_ros_pediatrics:skin_other_detail/><lib_ros_pediatrics:skin_composite/><lib_ros_pediatrics:neck_pain/><lib_ros_pediatrics:abnormal_position_head/><lib_ros_pediatrics:difficulties_walking/><lib_ros_pediatrics:frequent_falls/><lib_ros_pediatrics:head_tilt/><lib_ros_pediatrics:joint_stiffness/><lib_ros_pediatrics:joint_pain/><lib_ros_pediatrics:joint_swelling/><lib_ros_pediatrics:change_limb_use/><lib_ros_pediatrics:new_weakness/><lib_ros_pediatrics:muscle_other/><lib_ros_pediatrics:muscle_other_detail/><lib_ros_pediatrics:msk_composite/><lib_ros_pediatrics:excessive_thirst/><lib_ros_pediatrics:too_hot/><lib_ros_pediatrics:too_cold/><lib_ros_pediatrics:sluggish/><lib_ros_pediatrics:endocrine_other/><lib_ros_pediatrics:endocrine_other_detail/><lib_ros_pediatrics:endocrine_composite/><lib_ros_pediatrics:seasonal_allergies/><lib_ros_pediatrics:food_allergies/><lib_ros_pediatrics:allergies_other/><lib_ros_pediatrics:allergies_other_detail/><lib_ros_pediatrics:allergies_composite/><lib_ros_pediatrics:seizures/><lib_ros_pediatrics:abnormal_movements/><lib_ros_pediatrics:weakness/><lib_ros_pediatrics:bladder_change/><lib_ros_pediatrics:bowel_change/><lib_ros_pediatrics:ability_change/><lib_ros_pediatrics:brain_other/><lib_ros_pediatrics:brain_other_detail/><lib_ros_pediatrics:cns_composite/><lib_ros_pediatrics:snore/><lib_ros_pediatrics:gasp_sleep/><lib_ros_pediatrics:mouth_open/><lib_ros_pediatrics:sleep_walk/><lib_ros_pediatrics:wet_bed/><lib_ros_pediatrics:multiple_pillows/><lib_ros_pediatrics:positions/><lib_ros_pediatrics:morning_headaches/><lib_ros_pediatrics:gained_weight/><lib_ros_pediatrics:school_performance/><lib_ros_pediatrics:change_behavior/><lib_ros_pediatrics:refresh_after_sleep/><lib_ros_pediatrics:fall_asleep_short_drive/><lib_ros_pediatrics:asleep_school/><lib_ros_pediatrics:sleep_other/><lib_ros_pediatrics:sleep_other_detail/><lib_ros_pediatrics:sleep_composite/><lib_ros_pediatrics:sad/><lib_ros_pediatrics:tense/><lib_ros_pediatrics:alone_distress/><lib_ros_pediatrics:lack_interest_activities/><lib_ros_pediatrics:forgetful/><lib_ros_pediatrics:refuses_school/><lib_ros_pediatrics:distress_separate/><lib_ros_pediatrics:situation_fear/><lib_ros_pediatrics:cries_easily/><lib_ros_pediatrics:obsessive_thoughts/><lib_ros_pediatrics:temper_meltdowns/><lib_ros_pediatrics:throws_objects/><lib_ros_pediatrics:hits_self/><lib_ros_pediatrics:bites_self/><lib_ros_pediatrics:bangs_head/><lib_ros_pediatrics:irritable/><lib_ros_pediatrics:hits_others/><lib_ros_pediatrics:mood_swings/><lib_ros_pediatrics:unreal_happy/><lib_ros_pediatrics:hyperactivity/><lib_ros_pediatrics:impulsivity/><lib_ros_pediatrics:distracted/><lib_ros_pediatrics:uncooperative/><lib_ros_pediatrics:moves_slow/><lib_ros_pediatrics:aloof/><lib_ros_pediatrics:do_own/><lib_ros_pediatrics:not_respond_feelings/><lib_ros_pediatrics:arranges_objects/><lib_ros_pediatrics:upset_changes_routine/><lib_ros_pediatrics:repetitive_activity/><lib_ros_pediatrics:talk_self/><lib_ros_pediatrics:avoids_eye/><lib_ros_pediatrics:sensory_objects/><lib_ros_pediatrics:chews_parts/><lib_ros_pediatrics:emotional_other/><lib_ros_pediatrics:emotional_other_detail/><lib_ros_pediatrics:emotional_composite/><lib_immunizations:imm_influenza>0</lib_immunizations:imm_influenza><lib_immunizations:imm_influenza_day/><lib_immunizations:imm_influenza_where/><lib_immunizations:imm_pneumonia>0</lib_immunizations:imm_pneumonia><lib_immunizations:imm_tetanus_10>999</lib_immunizations:imm_tetanus_10><lib_family_hx:adopted>1</lib_family_hx:adopted><lib_family_hx:fhx/><lib_family_hx:fhx_celiac>1</lib_family_hx:fhx_celiac><lib_family_hx:fhx_celiac_mother/><lib_family_hx:fhx_celiac_father/><lib_family_hx:fhx_celiac_brother>1</lib_family_hx:fhx_celiac_brother><lib_family_hx:fhx_celiac_sister>1</lib_family_hx:fhx_celiac_sister><lib_family_hx:fhx_celiac_maternal/><lib_family_hx:fhx_celiac_maternal_gm/><lib_family_hx:fhx_celiac_maternal_gf/><lib_family_hx:fhx_celiac_maternal_aunt/><lib_family_hx:fhx_celiac_maternal_uncle/><lib_family_hx:fhx_celiac_maternal_cousin/><lib_family_hx:fhx_celiac_maternal_composite/><lib_family_hx:fhx_celiac_paternal/><lib_family_hx:fhx_celiac_paternal_gm/><lib_family_hx:fhx_celiac_paternal_gf/><lib_family_hx:fhx_celiac_paternal_aunt/><lib_family_hx:fhx_celiac_paternal_uncle/><lib_family_hx:fhx_celiac_paternal_cousin/><lib_family_hx:fhx_celiac_paternal_composite/><lib_family_hx:fhx_celiac_composite/><lib_family_hx:fhx_dm/><lib_family_hx:fhx_dm_mother/><lib_family_hx:fhx_dm_father/><lib_family_hx:fhx_dm_brother/><lib_family_hx:fhx_dm_sister/><lib_family_hx:fhx_dm_maternal/><lib_family_hx:fhx_dm_maternal_gm/><lib_family_hx:fhx_dm_maternal_gf/><lib_family_hx:fhx_dm_maternal_aunt/><lib_family_hx:fhx_dm_maternal_uncle/><lib_family_hx:fhx_dm_maternal_cousin/><lib_family_hx:fhx_dm_maternal_composite/><lib_family_hx:fhx_dm_paternal/><lib_family_hx:fhx_dm_paternal_gm/><lib_family_hx:fhx_dm_paternal_gf/><lib_family_hx:fhx_dm_paternal_aunt/><lib_family_hx:fhx_dm_paternal_uncle/><lib_family_hx:fhx_dm_paternal_cousin/><lib_family_hx:fhx_dm_paternal_composite/><lib_family_hx:fhx_dm_composite/><lib_family_hx:fhx_thyroid/><lib_family_hx:fhx_thyroid_mother/><lib_family_hx:fhx_thyroid_father/><lib_family_hx:fhx_thyroid_brother/><lib_family_hx:fhx_thyroid_sister/><lib_family_hx:fhx_thyroid_maternal/><lib_family_hx:fhx_thyroid_maternal_gm/><lib_family_hx:fhx_thyroid_maternal_gf/><lib_family_hx:fhx_thyroid_maternal_aunt/><lib_family_hx:fhx_thyroid_maternal_uncle/><lib_family_hx:fhx_thyroid_maternal_cousin/><lib_family_hx:fhx_thyroid_maternal_composite/><lib_family_hx:fhx_thyroid_paternal/><lib_family_hx:fhx_thyroid_paternal_gm/><lib_family_hx:fhx_thyroid_paternal_gf/><lib_family_hx:fhx_thyroid_paternal_aunt/><lib_family_hx:fhx_thyroid_paternal_uncle/><lib_family_hx:fhx_thyroid_paternal_cousin/><lib_family_hx:fhx_thyroid_paternal_composite/><lib_family_hx:fhx_thyroid_composite/><lib_family_hx:fhx_arthritis/><lib_family_hx:fhx_arthritis_mother/><lib_family_hx:fhx_arthritis_father/><lib_family_hx:fhx_arthritis_brother/><lib_family_hx:fhx_arthritis_sister/><lib_family_hx:fhx_arthritis_maternal/><lib_family_hx:fhx_arthritis_maternal_gm/><lib_family_hx:fhx_arthritis_maternal_gf/><lib_family_hx:fhx_arthritis_maternal_aunt/><lib_family_hx:fhx_arthritis_maternal_uncle/><lib_family_hx:fhx_arthritis_maternal_cousin/><lib_family_hx:fhx_arthritis_maternal_composite/><lib_family_hx:fhx_arthritis_paternal/><lib_family_hx:fhx_arthritis_paternal_gm/><lib_family_hx:fhx_arthritis_paternal_gf/><lib_family_hx:fhx_arthritis_paternal_aunt/><lib_family_hx:fhx_arthritis_paternal_uncle/><lib_family_hx:fhx_arthritis_paternal_cousin/><lib_family_hx:fhx_arthritis_paternal_composite/><lib_family_hx:fhx_arthritis_composite/><lib_family_hx:fhx_dementia/><lib_family_hx:fhx_dementia_mother/><lib_family_hx:fhx_dementia_father/><lib_family_hx:fhx_dementia_brother/><lib_family_hx:fhx_dementia_sister/><lib_family_hx:fhx_dementia_maternal/><lib_family_hx:fhx_dementia_maternal_gm/><lib_family_hx:fhx_dementia_maternal_gf/><lib_family_hx:fhx_dementia_maternal_aunt/><lib_family_hx:fhx_dementia_maternal_uncle/><lib_family_hx:fhx_dementia_maternal_cousin/><lib_family_hx:fhx_dementia_maternal_composite/><lib_family_hx:fhx_dementia_paternal/><lib_family_hx:fhx_dementia_paternal_gm/><lib_family_hx:fhx_dementia_paternal_gf/><lib_family_hx:fhx_dementia_paternal_aunt/><lib_family_hx:fhx_dementia_paternal_uncle/><lib_family_hx:fhx_dementia_paternal_cousin/><lib_family_hx:fhx_dementia_paternal_composite/><lib_family_hx:fhx_dementia_composite/><lib_family_hx:fhx_cvd/><lib_family_hx:fhx_cvd_mother/><lib_family_hx:fhx_cvd_father/><lib_family_hx:fhx_cvd_brother/><lib_family_hx:fhx_cvd_sister/><lib_family_hx:fhx_cvd_maternal/><lib_family_hx:fhx_cvd_maternal_gm/><lib_family_hx:fhx_cvd_maternal_gf/><lib_family_hx:fhx_cvd_maternal_aunt/><lib_family_hx:fhx_cvd_maternal_uncle/><lib_family_hx:fhx_cvd_maternal_cousin/><lib_family_hx:fhx_cvd_maternal_composite/><lib_family_hx:fhx_cvd_paternal/><lib_family_hx:fhx_cvd_paternal_gm/><lib_family_hx:fhx_cvd_paternal_gf/><lib_family_hx:fhx_cvd_paternal_aunt/><lib_family_hx:fhx_cvd_paternal_uncle/><lib_family_hx:fhx_cvd_paternal_cousin/><lib_family_hx:fhx_cvd_paternal_composite/><lib_family_hx:fhx_cvd_composite/><lib_family_hx:fhx_sz/><lib_family_hx:fhx_sz_mother/><lib_family_hx:fhx_sz_father/><lib_family_hx:fhx_sz_brother/><lib_family_hx:fhx_sz_sister/><lib_family_hx:fhx_sz_maternal/><lib_family_hx:fhx_sz_maternal_gm/><lib_family_hx:fhx_sz_maternal_gf/><lib_family_hx:fhx_sz_maternal_aunt/><lib_family_hx:fhx_sz_maternal_uncle/><lib_family_hx:fhx_sz_maternal_cousin/><lib_family_hx:fhx_sz_maternal_composite/><lib_family_hx:fhx_sz_paternal/><lib_family_hx:fhx_sz_paternal_gm/><lib_family_hx:fhx_sz_paternal_gf/><lib_family_hx:fhx_sz_paternal_aunt/><lib_family_hx:fhx_sz_paternal_uncle/><lib_family_hx:fhx_sz_paternal_cousin/><lib_family_hx:fhx_sz_paternal_composite/><lib_family_hx:fhx_sz_composite/><lib_family_hx:fhx_down/><lib_family_hx:fhx_down_mother/><lib_family_hx:fhx_down_father/><lib_family_hx:fhx_down_brother/><lib_family_hx:fhx_down_sister/><lib_family_hx:fhx_down_maternal/><lib_family_hx:fhx_down_maternal_gm/><lib_family_hx:fhx_down_maternal_gf/><lib_family_hx:fhx_down_maternal_aunt/><lib_family_hx:fhx_down_maternal_uncle/><lib_family_hx:fhx_down_maternal_cousin/><lib_family_hx:fhx_down_maternal_composite/><lib_family_hx:fhx_down_paternal/><lib_family_hx:fhx_down_paternal_gm/><lib_family_hx:fhx_down_paternal_gf/><lib_family_hx:fhx_down_paternal_aunt/><lib_family_hx:fhx_down_paternal_uncle/><lib_family_hx:fhx_down_paternal_cousin/><lib_family_hx:fhx_down_paternal_composite/><lib_family_hx:fhx_down_composite/><lib_family_hx:fhx_cancer/><lib_family_hx:fhx_cancer_mother/><lib_family_hx:fhx_cancer_father/><lib_family_hx:fhx_cancer_brother/><lib_family_hx:fhx_cancer_sister/><lib_family_hx:fhx_cancer_maternal/><lib_family_hx:fhx_cancer_maternal_gm/><lib_family_hx:fhx_cancer_maternal_gf/><lib_family_hx:fhx_cancer_maternal_aunt/><lib_family_hx:fhx_cancer_maternal_uncle/><lib_family_hx:fhx_cancer_maternal_cousin/><lib_family_hx:fhx_cancer_maternal_composite/><lib_family_hx:fhx_cancer_paternal/><lib_family_hx:fhx_cancer_paternal_gm/><lib_family_hx:fhx_cancer_paternal_gf/><lib_family_hx:fhx_cancer_paternal_aunt/><lib_family_hx:fhx_cancer_paternal_uncle/><lib_family_hx:fhx_cancer_paternal_cousin/><lib_family_hx:fhx_cancer_paternal_composite/><lib_family_hx:fhx_cancer_composite/><lib_family_hx:fhx_depression/><lib_family_hx:fhx_depression_mother/><lib_family_hx:fhx_depression_father/><lib_family_hx:fhx_depression_brother/><lib_family_hx:fhx_depression_sister/><lib_family_hx:fhx_depression_maternal/><lib_family_hx:fhx_depression_maternal_gm/><lib_family_hx:fhx_depression_maternal_gf/><lib_family_hx:fhx_depression_maternal_aunt/><lib_family_hx:fhx_depression_maternal_uncle/><lib_family_hx:fhx_depression_maternal_cousin/><lib_family_hx:fhx_depression_maternal_composite/><lib_family_hx:fhx_depression_paternal/><lib_family_hx:fhx_depression_paternal_gm/><lib_family_hx:fhx_depression_paternal_gf/><lib_family_hx:fhx_depression_paternal_aunt/><lib_family_hx:fhx_depression_paternal_uncle/><lib_family_hx:fhx_depression_paternal_cousin/><lib_family_hx:fhx_depression_paternal_composite/><lib_family_hx:fhx_depression_composite/><lib_family_hx:fhx_anxiety/><lib_family_hx:fhx_anxiety_mother/><lib_family_hx:fhx_anxiety_father/><lib_family_hx:fhx_anxiety_brother/><lib_family_hx:fhx_anxiety_sister/><lib_family_hx:fhx_anxiety_maternal/><lib_family_hx:fhx_anxiety_maternal_gm/><lib_family_hx:fhx_anxiety_maternal_gf/><lib_family_hx:fhx_anxiety_maternal_aunt/><lib_family_hx:fhx_anxiety_maternal_uncle/><lib_family_hx:fhx_anxiety_maternal_cousin/><lib_family_hx:fhx_anxiety_maternal_composite/><lib_family_hx:fhx_anxiety_paternal/><lib_family_hx:fhx_anxiety_paternal_gm/><lib_family_hx:fhx_anxiety_paternal_gf/><lib_family_hx:fhx_anxiety_paternal_aunt/><lib_family_hx:fhx_anxiety_paternal_uncle/><lib_family_hx:fhx_anxiety_paternal_cousin/><lib_family_hx:fhx_anxiety_paternal_composite/><lib_family_hx:fhx_anxiety_composite/><lib_family_hx:fhx_autism/><lib_family_hx:fhx_autism_mother/><lib_family_hx:fhx_autism_father/><lib_family_hx:fhx_autism_brother/><lib_family_hx:fhx_autism_sister/><lib_family_hx:fhx_autism_maternal/><lib_family_hx:fhx_autism_maternal_gm/><lib_family_hx:fhx_autism_maternal_gf/><lib_family_hx:fhx_autism_maternal_aunt/><lib_family_hx:fhx_autism_maternal_uncle/><lib_family_hx:fhx_autism_maternal_cousin/><lib_family_hx:fhx_autism_maternal_composite/><lib_family_hx:fhx_autism_paternal/><lib_family_hx:fhx_autism_paternal_gm/><lib_family_hx:fhx_autism_paternal_gf/><lib_family_hx:fhx_autism_paternal_aunt/><lib_family_hx:fhx_autism_paternal_uncle/><lib_family_hx:fhx_autism_paternal_cousin/><lib_family_hx:fhx_autism_paternal_composite/><lib_family_hx:fhx_autism_composite/><lib_family_hx:fhx_adhd/><lib_family_hx:fhx_adhd_mother/><lib_family_hx:fhx_adhd_father/><lib_family_hx:fhx_adhd_brother/><lib_family_hx:fhx_adhd_sister/><lib_family_hx:fhx_adhd_maternal/><lib_family_hx:fhx_adhd_maternal_gm/><lib_family_hx:fhx_adhd_maternal_gf/><lib_family_hx:fhx_adhd_maternal_aunt/><lib_family_hx:fhx_adhd_maternal_uncle/><lib_family_hx:fhx_adhd_maternal_cousin/><lib_family_hx:fhx_adhd_maternal_composite/><lib_family_hx:fhx_adhd_paternal/><lib_family_hx:fhx_adhd_paternal_gm/><lib_family_hx:fhx_adhd_paternal_gf/><lib_family_hx:fhx_adhd_paternal_aunt/><lib_family_hx:fhx_adhd_paternal_uncle/><lib_family_hx:fhx_adhd_paternal_cousin/><lib_family_hx:fhx_adhd_paternal_composite/><lib_family_hx:fhx_adhd_composite/><lib_family_hx:fhx_osa/><lib_family_hx:fhx_osa_mother/><lib_family_hx:fhx_osa_father/><lib_family_hx:fhx_osa_brother/><lib_family_hx:fhx_osa_sister/><lib_family_hx:fhx_osa_maternal/><lib_family_hx:fhx_osa_maternal_gm/><lib_family_hx:fhx_osa_maternal_gf/><lib_family_hx:fhx_osa_maternal_aunt/><lib_family_hx:fhx_osa_maternal_uncle/><lib_family_hx:fhx_osa_maternal_cousin/><lib_family_hx:fhx_osa_maternal_composite/><lib_family_hx:fhx_osa_paternal/><lib_family_hx:fhx_osa_paternal_gm/><lib_family_hx:fhx_osa_paternal_gf/><lib_family_hx:fhx_osa_paternal_aunt/><lib_family_hx:fhx_osa_paternal_uncle/><lib_family_hx:fhx_osa_paternal_cousin/><lib_family_hx:fhx_osa_paternal_composite/><lib_family_hx:fhx_osa_composite/><lib_family_hx:other_fhx_table><row><other_fhx_condition/><other_fhx_relation>_</other_fhx_relation></row></lib_family_hx:other_fhx_table><lib_dsp_living:living_situation>5</lib_dsp_living:living_situation><lib_dsp_living:living_situation_detail/><lib_dsp_living:living_situation_future_own>1</lib_dsp_living:living_situation_future_own><lib_dsp_living:living_situation_future_coordinator>1</lib_dsp_living:living_situation_future_coordinator><lib_dsp_living:living_situation_future_family/><lib_dsp_living:living_situation_future_roommate/><lib_dsp_living:living_situation_future_group/><lib_dsp_living:living_situation_future_other/><lib_dsp_living:living_situation_future_other_detail/><lib_dsp_living:living_situation_future/><lib_dsp_living:living_situation_overview>parent and sisters</lib_dsp_living:living_situation_overview><lib_dsp_devices:assistive_device_use>0</lib_dsp_devices:assistive_device_use><lib_dsp_devices:list_devices><row><device/></row></lib_dsp_devices:list_devices><lib_dsp_vocexp:in_school>0</lib_dsp_vocexp:in_school><lib_dsp_vocexp:school_name/><lib_dsp_vocexp:school_composite/><lib_dsp_vocexp:in_day_program>999</lib_dsp_vocexp:in_day_program><lib_dsp_vocexp:program_table><row><program_name/><program_days>1</program_days></row></lib_dsp_vocexp:program_table><lib_dsp_vocexp:employed>0</lib_dsp_vocexp:employed><lib_dsp_vocexp:work_table><row><work_name/><work_days>1</work_days></row></lib_dsp_vocexp:work_table><lib_dsp_vocexp:day_describe>hangs out at home all day</lib_dsp_vocexp:day_describe><lib_dsp_fxnal:comm_verbal/><lib_dsp_fxnal:comm_sign>1</lib_dsp_fxnal:comm_sign><lib_dsp_fxnal:comm_pictures/><lib_dsp_fxnal:comm_written/><lib_dsp_fxnal:comm_device/><lib_dsp_fxnal:comm_device_name/><lib_dsp_fxnal:comm_gesture/><lib_dsp_fxnal:comm_other/><lib_dsp_fxnal:comm_other_detail/><lib_dsp_fxnal:communication_composite/><lib_dsp_fxnal:smartphone_use>0</lib_dsp_fxnal:smartphone_use><lib_dsp_fxnal:smartphone_apps/><lib_dsp_fxnal:bathing_label/><lib_dsp_fxnal:bathing>0</lib_dsp_fxnal:bathing><lib_dsp_fxnal:toileting_label/><lib_dsp_fxnal:toileting>1</lib_dsp_fxnal:toileting><lib_dsp_fxnal:showering_label/><lib_dsp_fxnal:showering>0</lib_dsp_fxnal:showering><lib_dsp_fxnal:brushing_teeth_label/><lib_dsp_fxnal:brushing_teeth>1</lib_dsp_fxnal:brushing_teeth><lib_dsp_fxnal:cooking_label/><lib_dsp_fxnal:cooking>0</lib_dsp_fxnal:cooking><lib_dsp_fxnal:feeding_label/><lib_dsp_fxnal:feeding>1</lib_dsp_fxnal:feeding><lib_dsp_fxnal:dressing_label/><lib_dsp_fxnal:dressing>0</lib_dsp_fxnal:dressing><lib_dsp_fxnal:adls/><lib_dsp_fxnal:read>0</lib_dsp_fxnal:read><lib_dsp_fxnal:write>1</lib_dsp_fxnal:write><lib_dsp_recreation:activities>running</lib_dsp_recreation:activities><lib_dsp_recreation:hobbies>playing chess</lib_dsp_recreation:hobbies><lib_dsp_diet:breakfast>toast and butter</lib_dsp_diet:breakfast><lib_dsp_diet:lunch>rice and beans</lib_dsp_diet:lunch><lib_dsp_diet:dinner>tofu</lib_dsp_diet:dinner><lib_dsp_diet:snacks>kale chips</lib_dsp_diet:snacks><lib_dsp_diet:drinks>smoothies</lib_dsp_diet:drinks><lib_dsp_diet:diet_limit>gluten free</lib_dsp_diet:diet_limit><lib_dsp_diet:nutrition_care>1</lib_dsp_diet:nutrition_care><lib_dsp_diet:main_nutrition_goal>losing weight</lib_dsp_diet:main_nutrition_goal><lib_dsp_diet:diet/><lib_dsp_transitions:tsc_label/><lib_dsp_transitions:gen_md_phone>1</lib_dsp_transitions:gen_md_phone><lib_dsp_transitions:gen_md_phone_assist/><lib_dsp_transitions:gen_md_talk>1</lib_dsp_transitions:gen_md_talk><lib_dsp_transitions:gen_md_talk_assist/><lib_dsp_transitions:gen_sx_describe>1</lib_dsp_transitions:gen_sx_describe><lib_dsp_transitions:gen_sx_describe_assist/><lib_dsp_transitions:gen_meds>1</lib_dsp_transitions:gen_meds><lib_dsp_transitions:gen_meds_assist/><lib_dsp_transitions:gen_meds_reason>1</lib_dsp_transitions:gen_meds_reason><lib_dsp_transitions:gen_meds_reason_assist/><lib_dsp_transitions:gen_meds_take>0</lib_dsp_transitions:gen_meds_take><lib_dsp_transitions:gen_meds_take_assist/><lib_dsp_transitions:gen_rx>0</lib_dsp_transitions:gen_rx><lib_dsp_transitions:gen_rx_assist/><lib_dsp_transitions:gen_meds_swallow>0</lib_dsp_transitions:gen_meds_swallow><lib_dsp_transitions:gen_meds_swallow_assist/><lib_dsp_transitions:gen_id>0</lib_dsp_transitions:gen_id><lib_dsp_transitions:gen_id_assist/><lib_dsp_transitions:gen_stranger>0</lib_dsp_transitions:gen_stranger><lib_dsp_transitions:gen_stranger_assist/><lib_dsp_transitions:tsc_general_composite/><lib_dsp_transitions:well_foods>3</lib_dsp_transitions:well_foods><lib_dsp_transitions:well_foods_assist/><lib_dsp_transitions:well_habits>3</lib_dsp_transitions:well_habits><lib_dsp_transitions:well_habits_assist/><lib_dsp_transitions:well_911>3</lib_dsp_transitions:well_911><lib_dsp_transitions:well_911_assist/><lib_dsp_transitions:well_sleep>3</lib_dsp_transitions:well_sleep><lib_dsp_transitions:well_sleep_assist/><lib_dsp_transitions:well_exercise>3</lib_dsp_transitions:well_exercise><lib_dsp_transitions:well_exercise_assist/><lib_dsp_transitions:tsc_wellness_composite/><lib_dsp_transitions:self_public_transport>2</lib_dsp_transitions:self_public_transport><lib_dsp_transitions:self_public_transport_assist>0</lib_dsp_transitions:self_public_transport_assist><lib_dsp_transitions:self_chores>2</lib_dsp_transitions:self_chores><lib_dsp_transitions:self_chores_assist>1</lib_dsp_transitions:self_chores_assist><lib_dsp_transitions:self_period/><lib_dsp_transitions:self_period_assist/><lib_dsp_transitions:self_privacy>2</lib_dsp_transitions:self_privacy><lib_dsp_transitions:self_privacy_assist>0</lib_dsp_transitions:self_privacy_assist><lib_dsp_transitions:self_dentist>2</lib_dsp_transitions:self_dentist><lib_dsp_transitions:self_dentist_assist>1</lib_dsp_transitions:self_dentist_assist><lib_dsp_transitions:self_restroom>2</lib_dsp_transitions:self_restroom><lib_dsp_transitions:self_restroom_assist>0</lib_dsp_transitions:self_restroom_assist><lib_dsp_transitions:self_dress>0</lib_dsp_transitions:self_dress><lib_dsp_transitions:self_dress_assist/><lib_dsp_transitions:self_bathe>0</lib_dsp_transitions:self_bathe><lib_dsp_transitions:self_bathe_assist/><lib_dsp_transitions:self_meals>0</lib_dsp_transitions:self_meals><lib_dsp_transitions:self_meals_assist/><lib_dsp_transitions:self_laundry>1</lib_dsp_transitions:self_laundry><lib_dsp_transitions:self_laundry_assist/><lib_dsp_transitions:tsc_self_composite/><lib_dsp_transitions:know_insurance>1</lib_dsp_transitions:know_insurance><lib_dsp_transitions:know_insurance_assist/><lib_dsp_transitions:know_plan>3</lib_dsp_transitions:know_plan><lib_dsp_transitions:know_plan_assist/><lib_dsp_transitions:know_adults>3</lib_dsp_transitions:know_adults><lib_dsp_transitions:know_adults_assist/><lib_dsp_transitions:tsc_knowledge_composite/><lib_dsp_transitions:goal_1>learn to ride a bike</lib_dsp_transitions:goal_1><lib_dsp_transitions:goal_2/><lib_dsp_transitions:goal_3/><lib_dsp_transitions:top_goals_composite/><lib_dsp_labsdx:labsdx_label/><lib_dsp_labsdx:audio_2y>1</lib_dsp_labsdx:audio_2y><lib_dsp_labsdx:audio_2y_where>meei</lib_dsp_labsdx:audio_2y_where><lib_dsp_labsdx:audio_2y_date>fall 2009</lib_dsp_labsdx:audio_2y_date><lib_dsp_labsdx:audio_2y_normal>999</lib_dsp_labsdx:audio_2y_normal><lib_dsp_labsdx:audio_2y_results/><lib_dsp_labsdx:audio_2y_visit_detail/><lib_dsp_labsdx:ophtho_2y>999</lib_dsp_labsdx:ophtho_2y><lib_dsp_labsdx:ophtho_2y_where/><lib_dsp_labsdx:ophtho_2y_date/><lib_dsp_labsdx:ophtho_2y_normal/><lib_dsp_labsdx:ophtho_2y_results/><lib_dsp_labsdx:ophtho_2y_visit_detail/><lib_dsp_labsdx:sleep_study>999</lib_dsp_labsdx:sleep_study><lib_dsp_labsdx:sleep_study_where/><lib_dsp_labsdx:sleep_study_date/><lib_dsp_labsdx:sleep_study_normal/><lib_dsp_labsdx:sleep_study_results/><lib_dsp_labsdx:sleep_study_visit_detail/><lib_dsp_labsdx:dentist>999</lib_dsp_labsdx:dentist><lib_dsp_labsdx:dentist_who/><lib_dsp_labsdx:dentist_date/><lib_dsp_labsdx:dentist_visit_detail/><lib_dsp_labsdx:dentist_ds_specialist/><lib_dsp_labsdx:dental_insurance/><lib_dsp_labsdx:dental_concerns/><lib_dsp_labsdx:dentist_no_visit/><lib_dsp_labsdx:thyroid_test>999</lib_dsp_labsdx:thyroid_test><lib_dsp_labsdx:thyroid_test_where/><lib_dsp_labsdx:thyroid_test_date/><lib_dsp_labsdx:thyroid_test_normal/><lib_dsp_labsdx:thyroid_test_results/><lib_dsp_labsdx:thyroid_test_visit_detail/><lib_dsp_labsdx:celiac_test>999</lib_dsp_labsdx:celiac_test><lib_dsp_labsdx:celiac_test_where/><lib_dsp_labsdx:celiac_test_date/><lib_dsp_labsdx:celiac_test_normal/><lib_dsp_labsdx:celiac_test_results/><lib_dsp_labsdx:celiac_test_visit_detail/><lib_dsp_labsdx:cspine>999</lib_dsp_labsdx:cspine><lib_dsp_labsdx:cspine_where/><lib_dsp_labsdx:cspine_date/><lib_dsp_labsdx:cspine_normal/><lib_dsp_labsdx:cspine_results/><lib_dsp_labsdx:cspine_visit_detail/><lib_dsp_labsdx:hgb>999</lib_dsp_labsdx:hgb><lib_dsp_labsdx:hgb_where/><lib_dsp_labsdx:hgb_date/><lib_dsp_labsdx:hgb_normal/><lib_dsp_labsdx:hgb_results/><lib_dsp_labsdx:hgb_detail/><lib_dsp_labsdx:pap_smear/><lib_dsp_labsdx:pap_smear_age/><lib_dsp_labsdx:pap_smear_result/><lib_dsp_labsdx:pap_smear_detail/><lib_dsp_labsdx:mammogram/><lib_dsp_labsdx:mammogram_age/><lib_dsp_labsdx:mammogram_result/><lib_dsp_labsdx:mammogram_detail/><lib_dsp_labsdx:colonca_screening>999</lib_dsp_labsdx:colonca_screening><lib_dsp_labsdx:colonca_screening_age/><lib_dsp_labsdx:colonca_screening_result/><lib_dsp_labsdx:colonca_screening_detail/><lib_dsp_labsdx:dexa>999</lib_dsp_labsdx:dexa><lib_dsp_labsdx:dexa_age/><lib_dsp_labsdx:dexa_result/><lib_dsp_labsdx:dexa_detail/><lib_dsp_labsdx:if_answered_yes_adults/><lib_dsp_community:mgh_dsp_heading/><lib_dsp_community:mgh_dsp_email_table><row><mgh_dsp_email/><mgh_dsp_recipient/></row></lib_dsp_community:mgh_dsp_email_table><lib_dsp_community:msdc/><lib_dsp_community:msdc_member>0</lib_dsp_community:msdc_member><lib_dsp_community:mdsc_newsletters/><lib_dsp_community:mdsc_mailings/><lib_dsp_community:mdsc_link/><lib_dsp_community:dds/><lib_dsp_community:dds_child_eligibility>0</lib_dsp_community:dds_child_eligibility><lib_dsp_community:dds_link/><lib_dsp_community:ndss/><lib_dsp_community:ndss_newsletters>0</lib_dsp_community:ndss_newsletters><lib_dsp_community:ndss_link/><lib_dsp_community:ndsc/><lib_dsp_community:ndsc_newsletters>0</lib_dsp_community:ndsc_newsletters><lib_dsp_community:ndsc_link/><lib_dsp_community:dsrtf/><lib_dsp_community:dsrtf_newsletters>0</lib_dsp_community:dsrtf_newsletters><lib_dsp_community:dsrtf_link/><lib_dsp_community:rds/><lib_dsp_community:rds_newsletters>0</lib_dsp_community:rds_newsletters><lib_dsp_community:rds_link/><lib_dsp_community:special_olympics/><lib_dsp_community:special_olympics_member>0</lib_dsp_community:special_olympics_member><lib_dsp_community:special_olympics_link/><lib_dsp_plans:estate_plan>1</lib_dsp_plans:estate_plan><lib_dsp_plans:registered_vote>0</lib_dsp_plans:registered_vote><lib_dsp_plans:ssi>999</lib_dsp_plans:ssi><lib_dsp_plans:social_issues_other>social work</lib_dsp_plans:social_issues_other></model></submission>";

        String stylesheet = getStylesheet();


        TransformerFactory factory = TransformerFactory.newInstance();
//        InputStream stream = getClass().getClassLoader().getResourceAsStream("/edu/harvard/mgh/lcs/sprout/forms/study/stylesheets/updateAssertion.xsl");
        InputStream stream = new ByteArrayInputStream(stylesheet.getBytes());
        Transformer transformer = factory.newTransformer(new javax.xml.transform.stream.StreamSource(stream));
        transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");

        if (matchedAssertions != null && matchedAssertions.length > 0) {
            for (String matchedAssertion : matchedAssertions) {
                String variableName = extractAssertionVariableName(matchedAssertion);
                String value = extractAssertionValue(matchedAssertion);

                if (!StringUtils.isEmpty(variableName) && !StringUtils.isEmpty(value)) {
                    try {

                        System.out.println("variableName = " + variableName);

                        transformer.setParameter("variableName", variableName);
                        transformer.setParameter("fieldValue", value);
                        StreamSource ss = new StreamSource(new StringReader(submissionModel));
                        StringWriter writer = new StringWriter();
                        transformer.transform(ss, new javax.xml.transform.stream.StreamResult(writer));
                        submissionModel = writer.toString();
                    } catch (TransformerConfigurationException e) {
                        e.printStackTrace();
                    } catch (TransformerException e) {
                        e.printStackTrace();
                    }
                }

            }
        }

        System.out.println("beautify(submissionModel) = " + beautify(submissionModel));

    }


    private String extractAssertionVariableName(String assertion) {
        return assertion.indexOf("@") > 0 ? assertion.substring(assertion.lastIndexOf("@") + 1) : null;
    }

    private String extractAssertionValue(String assertion) {
        return assertion.indexOf("@") > 0 ? assertion.substring(0, assertion.lastIndexOf("@")) : null;
    }

    private String getStylesheet() {
        return "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" +
                "<xsl:stylesheet xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\" version=\"1.0\">\n" +
                "    <xsl:param name=\"fieldCode\" />\n" +
                "    <xsl:param name=\"fieldValue\" />\n" +
                "    \n" +
                "    <xsl:output method=\"xml\" encoding=\"utf-8\" omit-xml-declaration=\"yes\"/>\n" +
                "    <xsl:template match=\"@*|node()\">\n" +
                "        <xsl:copy>\n" +
                "            <xsl:apply-templates select=\"@*|node()\"/>\n" +
                "        </xsl:copy>\n" +
                "    </xsl:template>\n" +
                "    \n" +
                "    <xsl:template match=\"/submission/meta/user/identities/assertions/assertion/*\">\n" +
                "        <xsl:choose>\n" +
                "            <xsl:when test=\"(preceding-sibling::name = $fieldCode or following-sibling::name = $fieldCode) and name() = 'value'\">\n" +
                "                <xsl:copy>\n" +
                "                    <xsl:value-of select=\"$fieldValue\" />\n" +
                "                </xsl:copy>\n" +
                "            </xsl:when>\n" +
                "            <xsl:otherwise>\n" +
                "                <xsl:copy>\n" +
                "                    <xsl:apply-templates select=\"@* | node()\"/>\n" +
                "                </xsl:copy>\n" +
                "            </xsl:otherwise>\n" +
                "        </xsl:choose>\n" +
                "    </xsl:template>\n" +
                "    \n" +
                "\n" +
                "</xsl:stylesheet>";
    }


    private String beautify(String xmlCompressed) {
        try {
            TransformerFactory factory = TransformerFactory.newInstance();
            factory.setAttribute("indent-number", new Integer(4));

            String stylesheet = getBeautifyStylesheet();

            InputStream stream = new ByteArrayInputStream(stylesheet.getBytes());
            Transformer transformer = factory.newTransformer(new javax.xml.transform.stream.StreamSource(stream));
            transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");
            transformer.setOutputProperty(OutputKeys.INDENT, "yes");
            StreamSource streamSource = new StreamSource(new StringReader(xmlCompressed));
            StringWriter writer = new StringWriter();
            transformer.transform(streamSource, new javax.xml.transform.stream.StreamResult(writer));
            return writer.toString();
        } catch (TransformerConfigurationException e) {
            e.printStackTrace();
        } catch (TransformerException e) {
            e.printStackTrace();
        }
        return xmlCompressed;
    }


    private String getBeautifyStylesheet() {
        return "<xsl:stylesheet version=\"1.0\"\n" +
                "    xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">\n" +
                "    <xsl:output omit-xml-declaration=\"yes\" indent=\"yes\"/>\n" +
                "    \n" +
                "    <xsl:template match=\"node()|@*\">\n" +
                "        <xsl:copy>\n" +
                "            <xsl:apply-templates select=\"node()|@*\"/>\n" +
                "        </xsl:copy>\n" +
                "    </xsl:template>\n" +
                "</xsl:stylesheet>";
    }

}
